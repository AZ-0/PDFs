\ProvidesPackage{prelude}

%%%%%%%%%%%%%%%%%%%%%%%%%% IMPORTS %%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[utf8]{inputenc}     % good encoding
\usepackage[T1]{fontenc}        % good encoding
\usepackage{tgpagella}          % font
\usepackage{xcolor}             % color definitions
\usepackage{amsmath, amssymb, amsthm} % standard ams packages
\usepackage{mathtools}          % typesetting in mathmode
\usepackage[backend=biber,style=alphabetic]{biblatex} % citations
\usepackage{hyperref}           % refs
\usepackage[titles]{tocloft}    % titles
\usepackage{titlesec}           % titles
\usepackage{sectsty}            % sections
\usepackage{geometry}           % margins
\usepackage{quiver}             % diagrams
\usepackage{enumitem}           % managing enumerations
\usepackage{xparse}             % better commands
\usepackage{stmaryrd}           % ll/rr brackets
\usepackage[framemethod=tikz]{mdframed} % frames (props, thms, ...)
\usetikzlibrary{shadows}        % frame shadows
\usepackage{mathrsfs}           % mathscr font
\usepackage{pgffor}             % foreach macro
\usepackage{array}              % \newcolumntype macro
\usepackage{appendix}           % appendcices


%%%%%%%%%%%%%%%%%%%%%%%%%% CUSTOM COMMANDS %%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\bb}[1]{\mathbb{#1}}
\newcommand{\ca}[1]{\mathcal{#1}}
\newcommand{\fk}[1]{\mathfrak{#1}}
\newcommand{\sr}[1]{\mathscr{#1}}

\newcommand{\textdef}[1]{\textit{\textbf{#1}}}      % emph on defined word
\newcommand{\catname}[1]{{\normalfont\textsf{#1}}}  % category name
\newcommand{\infoname}[1]{{\normalfont\textsf{#1}}} % informatics name

% The Cech accent (eg. for Chech cohomology)
\newcommand{\vf}{\check{f}}
\newcommand{\vH}{\check{H}}
\newcommand{\vZ}{\check{Z}}

% -- Lowercase: fraktur (no redef \fi \fk)
\foreach \x in {a,b,c,d,e,f,g,h, j, l,m,n,o,p,q,r,s,t,u,w,x,y,z}{%
    \expandafter\xdef\csname f\x\endcsname{\noexpand\fk{\x}}%
}%

% -- Uppercase: blackboard, caligraphy, fraktur, script
\foreach \x in {A,...,Z}{%
    \expandafter\xdef\csname b\x\endcsname{\noexpand\bb{\x}}%
    \expandafter\xdef\csname c\x\endcsname{\noexpand\ca{\x}}%
    \expandafter\xdef\csname f\x\endcsname{\noexpand\fk{\x}}%
    \expandafter\xdef\csname s\x\endcsname{\noexpand\sr{\x}}%
}%

% -- Category names
\newcommand{\catdash}{\catname{-}}
\newcommand{\op}{\catname{op}}
\foreach \x in {%
    Ab, Aff, Alg, Coh, CRing, FinCov, FinEt, FinSepAlg, FinSet, Grp, LRS, Open, PSh, QCohAlg, Set, Sh%
}{%
    \expandafter\xdef\csname cat\x\endcsname{\noexpand\catname{\x}}%
}%

% -- Math Operators
\DeclareMathOperator{\hgt}{ht}
\DeclareMathOperator{\rk}{rg}
\foreach \x in {%
    Ann, Aut, Der, End, Frac, Gal, Hom, Spec, Spm, Tr,%
    adj, gr, im, lcm, ord, rad, rg, supp, trdeg, vol%
}{%
    \expandafter\xdef\csname\x\endcsname{\noexpand\operatorname{\x}}%
}%

% -- Math operators with \limits
\foreach \x in {%
    colim%
}{%
    \expandafter\xdef\csname\x\endcsname{\noexpand\operatorname*{\x}}%
}%

% -- Contextual things
\newcommand{\Nm}{\cN}
\newcommand{\Zmod}[1]{\bZ/#1\bZ}
\newcommand{\Qbar}{\overline\bQ}
\newcommand{\Zbar}{\overline\bZ}
\newcommand{\adh}[1]{\overline{#1}}
\newcommand{\expa}{{}^a}
\newcommand{\red}[1]{{#1}_{\catname{red}}}
\newcommand{\sat}[1]{{#1}_{\catname{sat}}}
\newcommand{\sep}[1]{{#1}_{\catname{sep}}}
\newcommand{\et}[1]{{#1}_{\catname{et}}}
\newcommand{\dd}{\mathrm{d}}

% Citations for stacks project
\newcommand\citestacks[1]{\cite[\href{https://stacks.math.columbia.edu/tag/#1}{#1}]{stacks-project}}

% Set
\NewDocumentCommand{\qty}{m o}{\left\{#1\IfValueT{#2}{\,\middle|\,#2}\right\}}
% Floor
\newcommand{\floor}[1]{\left\lfloor{#1}\right\rfloor}
% Absolute value
\newcommand{\abs}[1][\cdot]{\left|#1\right|}
\newcommand{\infabs}[1][\cdot]{\abs[#1]_\infty}
\newcommand{\norm}[1]{\left\|#1\right\|}
% Coords
\NewDocumentCommand{\coords}{O{1} m O{n} O{,}}{\left(#2_#1#4 \ldots#4 #2_#3\right)}
\NewDocumentCommand{\projcoords}{O{0} m O{n}}{\coords[#1]{#2}[#3][:]}
% Math columns in tabular
\newcolumntype{L}{>{$}l<{$}}
\newcolumntype{C}{>{$}c<{$}}
\newcolumntype{R}{>{$}r<{$}}


%%%%%%%%%%%%%%%%%%%%%%%%%% COLORS %%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{aqua}{rgb}{0.0,0.6,0.7}
\definecolor{ltgreen}{rgb}{0.0,0.8,0.7}
\definecolor{ltblue}{rgb}{0.0,0.2,0.7}
\definecolor{ocre}{RGB}{0, 113, 188}
\definecolor{dkgreen}{RGB}{113, 188, 113}
\definecolor{coral}{RGB}{233, 137, 128}

%%%%%%%%%%%%%%%%%%%%%%%%%% THM ENVS %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% Styles
\mdfdefinestyle{theorem}{
    roundcorner=2pt,
    linewidth=3pt,
    innertopmargin=0pt,
    innerbottommargin=5pt,
    shadow=true,
    shadowsize=6pt,
    nobreak=true,
}

\mdfdefinestyle{prop}{
    hidealllines=true,
    roundcorner=2pt,
    leftline=true,
    linewidth=3pt,
    innertopmargin=0pt,
    innerbottommargin=5pt,
    nobreak=true,
}

\newtheoremstyle{plain*}{\topsep}{\topsep}{\itshape}{0pt}{}{.}{5pt plus 1pt minus 1pt}{{\bfseries\thmname{#1}}\ifstrempty{#3}{}{ (\thmnote{#3})}}

\newtheoremstyle{definition*}{\topsep}{\topsep}{}{0pt}{}{.}{3pt plus 1pt minus 1pt}{{\bfseries\thmname{#1}}\ifstrempty{#3}{}{ (\thmnote{#3})}}

%%%%%%%%%% Abstract Commands
\newcounter{globalctr}[section]
\renewcommand{\theglobalctr}{\arabic{section}.\arabic{globalctr}}

\newcommand\propenvmaker[4]{
    \theoremstyle{#1}
    \newmdtheoremenv[
        style=prop,
        linecolor=#2,
    ]{#3}[globalctr]{\textbf{#4}}
}

\newcommand\thmenvmaker[5]{
    \theoremstyle{#1}
    \newmdtheoremenv[
        style=theorem,
        linecolor=#2,
        backgroundcolor=#3,
    ]{#4}[globalctr]{\textbf{#5}}
}

\newcommand{\newpropenv}[4][definition]{
    \propenvmaker{#1}{#2}{@#3}{#4}
    \propenvmaker{#1*}{#2}{@#3*}{#4}

    \newenvironment{#3}{\begin{@#3}}{\end{@#3}\vspace*{-3pt}}
    \newenvironment{#3*}{\begin{@#3*}}{\end{@#3*}\vspace*{-3pt}}
}

\newcommand{\newthmenv}[5][plain]{
    \thmenvmaker{#1}{#2}{#3}{#4}{#5}
    \thmenvmaker{#1*}{#2}{#3}{#4*}{#5}
}

%%%%%%%%%% Property-like
\newpropenv[plain]{ocre}{proposition}{Proposition}
\newpropenv[plain]{aqua}{lemme}{Lemme}
\newpropenv[plain]{ltgreen}{corollaire}{Corollaire}

\newpropenv{dkgreen}{exemple}{Exemple}
\newpropenv{dkgreen}{remarque}{Remarque}
\newpropenv{ltblue}{exercice}{Exercice}

%%%%%%%%%% Theorem-like
\newthmenv{ocre}{blue!5}{theoreme}{Théorème}
\newthmenv{coral}{red!5}{definition}{Définition}

%%%%%%%%%% Proof-like
\newenvironment{preuve}[1][\unskip]{%
    \vspace*{-3pt}\noindent%
    \textcolor{gray}{\textit{\textsf{Preuve}}}%
    { #1}%
    \textcolor{gray}{\textit{\textsf{.}}}
}{\qed\medskip}
\newenvironment{preuve*}[1][\unskip]{%
    \vspace*{-3pt}\noindent%
    \textcolor{gray}{\textit{\textsf{Preuve}}}%
    { #1}%
    \textcolor{gray}{\textit{\textsf{.}}}
}{}



%%%%%%%%%%%% Table of contents %%%%%%%%%%%%

% Change TOC name
\renewcommand{\contentsname}{Table des matières}

\makeatletter%
\@ifclassloaded{report}%
  {%
    % Changes chapter formatting in the table of contents
    \renewcommand{\cftchapfont}{\LARGE\bfseries\hypersetup{linkcolor=black!90}\sffamily}
    \renewcommand{\cftchappagefont}{\LARGE\bfseries\sffamily}
    \renewcommand{\cftchapleader}{\bfseries\hfill}
    \renewcommand{\cftchapdotsep}{2}
    \renewcommand{\cftbeforechapskip}{\baselineskip}
    \renewcommand{\cftchapafterpnum}{\vskip5pt}
  }%
  {}%
\makeatother%

% Changes section formatting in the table of contents
\renewcommand{\cftsecfont}{\Large\bfseries\hypersetup{linkcolor=black!70}\sffamily}
\renewcommand{\cftsecpagefont}{\Large\bfseries\sffamily}
\renewcommand{\cftsecleader}{\cftdotfill{\cftchapdotsep}}
\renewcommand{\cftsecafterpnum}{\vskip5pt}

% Changes subsection formatting in the table of contents
\renewcommand{\cftsubsecfont}{\large}
\renewcommand{\cftsubsecpagefont}{\large}
\renewcommand{\cftsubsecafterpnum}{\vskip5pt}

% Changes subsection formatting in the table of contents
\renewcommand{\cftsubsubsecfont}{\medium}
\renewcommand{\cftsubsubsecpagefont}{\medium}
\renewcommand{\cftsubsubsecafterpnum}{\vskip5pt}

% Avoids indentations in the TOC
% \setlength{\cftsecindent}{0pt}
% \setlength{\cftsubsecindent}{0pt}
% \setlength{\cftsubsubsecindent}{5pt}



%%%%%%%%%%%%%%%%%%%%%%%%%% MISC %%%%%%%%%%%%%%%%%%%%%%%%%%
% Margins
\geometry{hmargin=2cm,vmargin=2cm}

% Alineas at the beginning of a new paragraph 
\setlength{\parindent}{0.4cm}

% Formates links
\hypersetup{
    colorlinks,
    citecolor=ocre,
    filecolor=ocre,
    linkcolor=ocre,
    urlcolor=ocre
}

% Changes chapter's title format
\renewcommand\thechapter{\arabic{chapter}}
\titleformat{\chapter}[display]{\centering\bfseries\Huge}{}{5pt}{Chapitre \thechapter \: }
\titleformat{name=\chapter,numberless}[display]{\centering\bfseries\huge}{}{5pt}{}

% Appendices
\renewcommand{\appendixpagename}{Annexes}
\renewcommand{\appendixtocname}{Annexes}

\newcommand\setupappendixmode{
    \renewcommand\thechapter{\Alph{chapter}}
}